<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>API Omeka S — Enregistrement audio + upload</title>
  <style>
    button { margin: 6px 4px; }
    pre { background:#f5f5f5; padding:10px; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>Enregistrer la voix et envoyer vers Omeka S</h1>

  <section>
    <h2>Enregistrement</h2>
    <label>Nom de l’artiste / titre de l'enregistrement :</label>
    <input id="nomArtiste" type="text" placeholder="Ex : Nougaro" />
    <div>
      <button id="btnStart">Démarrer l'enregistrement</button>
      <button id="btnStop" disabled>Arrêter</button>
      <button id="btnUpload" disabled>Envoyer à Omeka</button>
    </div>

    <div>
      <p>Durée / statut : <span id="status">—</span></p>
      <audio id="player" controls style="display:none"></audio>
    </div>

    <pre id="log">Logs : aucun</pre>
  </section>

  <script>
    // ==== CONFIG ====
    const baseURL = "http://localhost/omk_thyp_25-26_clone/omeka-s/api/items";
    const key_identity = "v93tumeJwroU6cKf7hkIDjgVr5FFZHBn";
    const key_credential = "1xPr6ZPSgnawyRLJwPKB5m6MejBU4xEg";
    // Resource template 
    const RESOURCE_TEMPLATE_ID = 7; 
    const RESOURCE_CLASS_ID = 108;  
    // propriété id pour "dcterms:title" 
    const PROP_TITLE_ID = 1;
    const PROP_NOMARTISTE_ID = 189;

    // ==== UI refs ====
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const btnUpload = document.getElementById("btnUpload");
    const statusEl = document.getElementById("status");
    const player = document.getElementById("player");
    const logEl = document.getElementById("log");
    const inputNom = document.getElementById("nomArtiste");

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob; 

    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    }

    // Demande d'autorisation et démarrage
    btnStart.addEventListener("click", async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => {
          if (e.data && e.data.size > 0) audioChunks.push(e.data);
        };
        mediaRecorder.onstart = () => {
          statusEl.textContent = "Enregistrement…";
          btnStart.disabled = true;
          btnStop.disabled = false;
          btnUpload.disabled = true;
          log("Enregistrement démarré");
        };
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); // format webm/container
          const url = URL.createObjectURL(audioBlob);
          player.src = url;
          player.style.display = "block";
          btnStart.disabled = false;
          btnStop.disabled = true;
          btnUpload.disabled = false;
          statusEl.textContent = "Enregistrement arrêté (prêt à envoyer)";
          log("Enregistrement arrêté et blob créé (" + (audioBlob.size/1024).toFixed(1) + " KB)");
        };
        mediaRecorder.start();
      } catch (err) {
        log("Erreur getUserMedia : " + err.message);
        statusEl.textContent = "Erreur d'accès au micro";
      }
    });

    // Arrêt
    btnStop.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        statusEl.textContent = "Arrêt en cours...";
      }
    });

    // Upload vers Omeka : crée d'abord l'item (POST multipart/form-data avec data + file[0])
    btnUpload.addEventListener("click", async () => {
      if (!audioBlob) {
        log("Aucun enregistrement à envoyer.");
        return;
      }
      const nom = (inputNom.value || "").trim();
      if (!nom) {
        alert("Donne un nom / titre avant d'envoyer.");
        return;
      }

      btnUpload.disabled = true;
      statusEl.textContent = "Envoi en cours...";
      log("Préparation de l'envoi...");

      // Prépare les métadonnées pour Omeka (o:title + propriétés)
      const metadata = {
        "o:resource_template": { "o:id": RESOURCE_TEMPLATE_ID },
        "o:resource_class": { "o:id": RESOURCE_CLASS_ID },
        "o:is_public": true,
        "o:title": nom,
        "o:properties": {}
      };

      // Ajoute la propriété dcterms:title (1) et la propriété spécifique (189) 
      metadata["o:properties"][String(PROP_TITLE_ID)] = [
        { "@value": nom, "type": "literal", "@language": "fr" }
      ];
      metadata["o:properties"][String(PROP_NOMARTISTE_ID)] = [
        { "@value": nom, "type": "literal", "@language": "fr" }
      ];

      // Construis FormData : "data" = JSON, "file[0]" = audio blob
      const fd = new FormData();
      fd.append("data", JSON.stringify(metadata));

      // Nom de fichier 
      const filename = nom.replace(/\s+/g, "_") + ".webm";
      fd.append("file[0]", audioBlob, filename);

      // Envoi 
      const url = `${baseURL}?key_identity=${encodeURIComponent(key_identity)}&key_credential=${encodeURIComponent(key_credential)}`;

      try {
        log("Envoi POST -> " + url);
        const resp = await fetch(url, {
          method: "POST",
          body: fd,
        });

        // Debug : récupère texte si erreur
        if (!resp.ok) {
          const text = await resp.text();
          log("Réponse non OK : " + resp.status + " — " + text);
          statusEl.textContent = "Erreur lors de l'envoi (" + resp.status + ")";
          btnUpload.disabled = false;
          return;
        }

        const json = await resp.json();
        log("Upload réussi. Réponse : " + JSON.stringify(json));
        statusEl.textContent = "Upload OK — item créé";
        // montre le résultat
        alert("Upload réussi — item créé. Vérifie Omeka.");
      } catch (err) {
        log("Erreur fetch/upload : " + err.message);
        statusEl.textContent = "Erreur réseau / API";
      } finally {
        btnUpload.disabled = false;
      }
    });
  </script>
</body>
</html>

