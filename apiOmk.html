<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>API Omeka S - Création Item + Upload Média</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; }
    pre { background:#f5f5f5; padding:8px; white-space:pre-wrap; }
    .row { margin-bottom:12px; }
    label { margin-right:8px; }
    input[type="text"] { padding:4px; }
    button { margin-left:6px; }
  </style>
</head>
<body>
  <h1>Omeka S — créer item & uploader média</h1>

  <!-- ================== LIRE ITEMS ================== -->
  <section>
    <h2>1) Lire les items</h2>
    <div class="row">
      <button id="btnGet">Afficher les items</button>
    </div>
    <pre id="resultat"></pre>
  </section>

  <!-- ================== CREER ITEM ================== -->
  <section>
    <h2>2) Créer un item (titre obligatoire)</h2>
    <form id="formCreate">
      <label>Titre : <input type="text" id="title" required></label>
      <label style="margin-left:12px">Description : <input type="text" id="desc"></label>
      <button type="submit">Créer item</button>
    </form>
    <pre id="createResult"></pre>
  </section>

  <!-- ================== UPLOAD MEDIA ================== -->
  <section>
    <h2>3) Uploader un média vers l'item (image / audio)</h2>
    <div class="row">
      <label>Choisir un fichier (image/audio): <input type="file" id="fileInput"></label>
      <button id="btnUploadFile">Uploader le fichier vers l'item créé</button>
    </div>

    <pre id="uploadResult"></pre>
  </section>

<script>
/* ====================== CONFIG ====================== */
const baseURL = "http://localhost/omk_thyp_25-26_clone/omeka-s/api/items";
const key_identity = "v93tumeJwroU6cKf7hkIDjgVr5FFZHBn";
const key_credential = "1xPr6ZPSgnawyRLJwPKB5m6MejBU4xEg";

// Media endpoint
const mediaURL = baseURL.replace("/items", "/media");

// Helper
function urlWithKeys(url) {
  const sep = url.includes("?") ? "&" : "?";
  return `${url}${sep}key_identity=${encodeURIComponent(key_identity)}&key_credential=${encodeURIComponent(key_credential)}`;
}

/* ====================== LECTURE ITEMS ====================== */
document.getElementById("btnGet").addEventListener("click", async () => {
  const target = document.getElementById("resultat");
  target.textContent = "Chargement...";
  try {
    const res = await fetch(urlWithKeys(baseURL));
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    let txt = "";
    data.forEach(item => {
      txt += `#${item["o:id"]} — ${item["o:title"] || "(sans titre)"}\n`;
    });
    target.textContent = txt;
  } catch (e) {
    target.textContent = "Erreur : " + e.message;
  }
});

/* ====================== CREATION ITEM ====================== */
document.getElementById("formCreate").addEventListener("submit", async (ev) => {
  ev.preventDefault();

  const title = document.getElementById("title").value.trim();
  const desc  = document.getElementById("desc").value.trim();

  if (!title) return alert("Titre requis");

  const newItem = {
    "o:is_public": true,
    "dcterms:title": [
      { "type": "literal", "property_id": "auto", "@value": title }
    ]
  };

  if (desc) {
    newItem["dcterms:description"] = [
      { "type": "literal", "property_id": "auto", "@value": desc }
    ];
  }

  const out = document.getElementById("createResult");
  out.textContent = "Création...";

  try {
    const r = await fetch(urlWithKeys(baseURL), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newItem)
    });

    const text = await r.text();
    let json;
    try { json = JSON.parse(text); }
    catch { json = text; }

    if (!r.ok) {
      out.textContent = "❌ Erreur création : " + JSON.stringify(json);
      return;
    }

    out.textContent = "✅ Item créé :\n" + JSON.stringify(json, null, 2);

    // extraction ID
    let id = json["o:id"];
    if (!id && json["@id"]) {
      const m = /\/items\/(\d+)$/.exec(json["@id"]);
      if (m) id = parseInt(m[1], 10);
    }

    window.lastCreatedItem = id;
    out.textContent += "\nID: " + id;

  } catch (err) {
    out.textContent = "❌ Erreur fetch : " + err;
  }
});

/* ====================== UPLOAD MEDIA ====================== */
async function uploadFileToItem(file, itemId) {
  const out = document.getElementById("uploadResult");

  if (!file) return alert("Choisis un fichier");
  if (!itemId) return alert("Crée un item d'abord");

  out.textContent = "Upload en cours...";
  console.log("Upload file →", file);

  const fd = new FormData();
  fd.append("file", file, file.name);  // FONDAMENTAL
  fd.append("o:item", String(itemId)); // PAS DE JSON !
  fd.append("o:ingester", "upload");

  try {
    const r = await fetch(urlWithKeys(mediaURL), {
      method: "POST",
      body: fd
    });

    const text = await r.text();
    let parsed;
    try { parsed = JSON.parse(text); }
    catch { parsed = text; }

    console.log("Réponse upload :", r.status, parsed);

    if (!r.ok) {
      out.textContent = "❌ Erreur upload : " + JSON.stringify(parsed);
      return;
    }

    out.textContent = "✅ Upload OK :\n" + JSON.stringify(parsed, null, 2);

  } catch (e) {
    out.textContent = "❌ Erreur fetch : " + e;
  }
}

document.getElementById("btnUploadFile").addEventListener("click", async () => {
  const f = document.getElementById("fileInput").files[0];
  const id = window.lastCreatedItem;
  uploadFileToItem(f, id);
});
</script>

</body>
</html>
